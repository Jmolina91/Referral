<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Dashboard - User Management</title>
  <style>
    /* ... your existing CSS unchanged ... */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      display: flex;
      background-color: #f2f2f2;
    }
    .sidebar {
      width: 200px;
      background-color: #2c3e50;
      height: 100vh;
      padding-top: 20px;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
    }
    .sidebar button {
      display: block;
      width: 100%;
      padding: 10px 20px;
      background-color: #34495e;
      color: white;
      border: none;
      text-align: left;
      cursor: pointer;
      margin-bottom: 5px;
      font-size: 16px;
      transition: background-color 0.3s ease;
    }
    .sidebar button:hover,
    .sidebar button.active {
      background-color: #3d566e;
    }
    .content {
      flex-grow: 1;
      padding: 20px;
      overflow-x: auto;
    }
    section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    h2 {
      color: #333;
      margin-top: 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ccc;
      text-align: left;
      vertical-align: middle;
    }
    input[type="number"] {
      width: 60px;
      padding: 4px;
      font-size: 14px;
    }
    .approve-btn {
      background-color: #5cb85c;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 5px;
    }
    .deny-btn {
      background-color: #d9534f;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    .set-paid-btn {
      background-color: #007bff;
      color: white;
      padding: 5px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-left: 5px;
    }
  </style>
</head>
<body>

<div class="sidebar">
  <button id="btn-pending" onclick="toggleSection('pending')">Pending Approvals</button>
  <button id="btn-approved" onclick="toggleSection('approved')">Approved Users</button>
</div>

<div class="content">
  <section id="pending-section" style="display:none">
    <h2>Pending User Approvals</h2>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Email</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="pending-user-list">
        <tr><td colspan="3">Loading...</td></tr>
      </tbody>
    </table>
  </section>

  <section id="approved-section" style="display:none">
    <h2>Approved Users</h2>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Email</th>
          <th>Revoke Approval</th>
        </tr>
      </thead>
      <tbody id="approved-user-list">
        <tr><td colspan="3">Loading...</td></tr>
      </tbody>
    </table>
  </section>

  <section id="order-summary-section">
    <h2>Order Summary</h2>
    <table>
      <thead>
        <tr>
          <th>Order Number</th>
          <th>Username</th>
          <th>Referral Code</th>
          <th>Product</th>
          <th>Quantity</th>
          <th>Price</th>
          <th>Referral Names</th>
          <th>Date</th>
          <th>Quantity Paid</th>
          <th>Summary Paid</th>
        </tr>
      </thead>
      <tbody id="order-list">
        <tr><td colspan="10">Loading...</td></tr>
      </tbody>
    </table>
  </section>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDMx67HEtpWr7fPDsnBIBGznXTP9MIU9QU",
    authDomain: "mushroom-referral.firebaseapp.com",
    projectId: "mushroom-referral",
    storageBucket: "mushroom-referral.appspot.com",
    messagingSenderId: "1038687686201",
    appId: "1:1038687686201:web:c130be2734a3d42122c7e8",
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const pendingList = document.getElementById("pending-user-list");
  const approvedList = document.getElementById("approved-user-list");
  const orderList = document.getElementById("order-list");

  const pendingSection = document.getElementById("pending-section");
  const approvedSection = document.getElementById("approved-section");
  const orderSummarySection = document.getElementById("order-summary-section");

  const btnPending = document.getElementById("btn-pending");
  const btnApproved = document.getElementById("btn-approved");

  function clearActiveButtons() {
    btnPending.classList.remove('active');
    btnApproved.classList.remove('active');
  }

  function toggleSection(section) {
    if (section === "pending") {
      pendingSection.style.display = "block";
      approvedSection.style.display = "none";
      orderSummarySection.style.display = "none";
      clearActiveButtons();
      btnPending.classList.add('active');
    } else if (section === "approved") {
      pendingSection.style.display = "none";
      approvedSection.style.display = "block";
      orderSummarySection.style.display = "none";
      clearActiveButtons();
      btnApproved.classList.add('active');
    } else {
      // Hide both and show order summary
      pendingSection.style.display = "none";
      approvedSection.style.display = "none";
      orderSummarySection.style.display = "block";
      clearActiveButtons();
    }
  }

  async function fetchUsers() {
    // Pending users
    const pendingSnapshot = await db.collection('users').where('approved', '==', false).get();
    pendingList.innerHTML = pendingSnapshot.empty
      ? "<tr><td colspan='3'>No pending users.</td></tr>"
      : "";

    pendingSnapshot.forEach(doc => {
      const user = doc.data();
      pendingList.innerHTML += 
        `<tr>
          <td>${user.name || '(No name)'}</td>
          <td>${user.email}</td>
          <td>
            <button class="approve-btn" onclick="approveUser('${doc.id}')">Approve</button>
            <button class="deny-btn" onclick="denyUser('${doc.id}')">Deny</button>
          </td>
        </tr>`;
    });

    // Approved users
    const approvedSnapshot = await db.collection('users').where('approved', '==', true).get();
    approvedList.innerHTML = approvedSnapshot.empty
      ? "<tr><td colspan='3'>No approved users.</td></tr>"
      : "";

    approvedSnapshot.forEach(doc => {
      const user = doc.data();
      approvedList.innerHTML += 
        `<tr>
          <td>${user.name || '(No name)'}</td>
          <td>${user.email}</td>
          <td><button class="deny-btn" onclick="denyUser('${doc.id}')">Remove</button></td>
        </tr>`;
    });
  }

  async function fetchOrders() {
    orderList.innerHTML = "<tr><td colspan='10'>Loading...</td></tr>";
    const ordersSnapshot = await db.collection('orders').orderBy('createdAt', 'desc').limit(50).get();

    if (ordersSnapshot.empty) {
      orderList.innerHTML = "<tr><td colspan='10'>No orders found.</td></tr>";
      return;
    }

    orderList.innerHTML = "";
    ordersSnapshot.forEach(doc => {
      const order = doc.data();
      const date = order.createdAt?.toDate().toLocaleString() || "N/A";
      const referrals = (order.referralNames || []).join(', ');
      const pricePerItem = order.totalPrice / order.quantity;
      const rowId = doc.id;

      const quantityPaid = order.quantityPaid || 0;
      const summaryPaid = order.summaryPaid || 0;

      const referralCode = order.referralCode || "N/A";

      orderList.innerHTML += 
        `<tr>
          <td>${order.orderNumber || '(No Order Number)'}</td>
          <td>${order.username || 'Unknown'}</td>
          <td>${referralCode}</td>
          <td>${order.product || 'Unknown'}</td>
          <td>${order.quantity}</td>
          <td>₱${order.totalPrice.toFixed(2)}</td>
          <td>${referrals}</td>
          <td>${date}</td>
          <td>
            <input type="number" id="paidQty-${rowId}" min="0" max="${order.quantity}" value="${quantityPaid}" />
            <button class="set-paid-btn" onclick="savePayment('${rowId}', ${pricePerItem})">Set</button>
          </td>
          <td><span id="summaryPaid-${rowId}">₱${summaryPaid.toFixed(2)}</span></td>
        </tr>`;
    });
  }

  async function approveUser(userId) {
    if (confirm("Approve this user?")) {
      await db.collection('users').doc(userId).update({ approved: true });
      fetchUsers();
    }
  }

  async function denyUser(userId) {
    if (confirm("Remove this user?")) {
      await db.collection('users').doc(userId).delete();
      fetchUsers();
    }
  }

  async function savePayment(rowId, unitPrice) {
    const qtyInput = document.getElementById(`paidQty-${rowId}`);
    let qty = parseInt(qtyInput.value);
    const maxQty = parseInt(qtyInput.max);

    if (isNaN(qty) || qty < 0) {
      alert("Please enter a valid quantity.");
      qtyInput.value = 0;
      document.getElementById(`summaryPaid-${rowId}`).textContent = "₱0.00";
      return;
    }

    if (qty > maxQty) {
      alert(`Quantity cannot exceed the ordered amount (${maxQty}).`);
      qty = maxQty;
      qtyInput.value = maxQty;
    }

    const totalPaid = qty * unitPrice;
    document.getElementById(`summaryPaid-${rowId}`).textContent = `₱${totalPaid.toFixed(2)}`;

    try {
      // Update the main order doc
      await db.collection('orders').doc(rowId).update({
        quantityPaid: qty,
        summaryPaid: totalPaid,
      });

      // Also add a document to Admin Orders subcollection under this order
      // Let's add with an autogenerated ID to keep history of admin payments
await db.collection('orders').doc(rowId).collection('adminOrders').add({
  updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
  quantityPaid: qty,
  summaryPaid: totalPaid,
  updatedBy: firebase.auth().currentUser.uid || 'unknown',
});

alert("Payment info updated and saved to Admin Orders.");
fetchOrders();
} catch (error) {
  alert("Failed to update payment info: " + error.message);
}

  }

  // On page load
  firebase.auth().onAuthStateChanged(async user => {
    if (!user) {
      window.location.href = "Referral Login.html";
      return;
    }

    const userDoc = await db.collection("users").doc(user.uid).get();
    if (!userDoc.exists || !userDoc.data().isAdmin) {
      alert("Access denied. Not an admin.");
      await firebase.auth().signOut();
      window.location.href = "Referral Login.html";
      return;
    }

    toggleSection(''); // show order summary by default
    fetchUsers();
    fetchOrders();
  });
</script>
</body>
</html>
