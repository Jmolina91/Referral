<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Dashboard - User Management</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 30px;
      background-color: #f2f2f2;
      display: flex;
      gap: 40px;
      flex-wrap: wrap;
    }
    section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      flex: 1 1 450px;
      min-width: 300px;
    }
    h2 {
      color: #333;
      margin-top: 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ccc;
      text-align: left;
    }
    button {
      padding: 5px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      color: white;
      margin-right: 5px;
    }
    .approve-btn {
      background-color: #5cb85c;
    }
    .approve-btn:hover {
      background-color: #4cae4c;
    }
    .deny-btn {
      background-color: #d9534f;
    }
    .deny-btn:hover {
      background-color: #c9302c;
    }
    .revoke-btn {
      background-color: #f0ad4e;
    }
    .revoke-btn:hover {
      background-color: #ec971f;
    }
  </style>
</head>
<body>

<section>
  <h2>Pending User Approvals</h2>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Email</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="pending-user-list">
      <tr><td colspan="3">Loading...</td></tr>
    </tbody>
  </table>
</section>

<section>
  <h2>Approved Users</h2>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Email</th>
        <th>Revoke Approval</th>
      </tr>
    </thead>
    <tbody id="approved-user-list">
      <tr><td colspan="3">Loading...</td></tr>
    </tbody>
  </table>
</section>

<!-- Firebase App (the core Firebase SDK) -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<!-- Firebase Firestore -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<!-- Firebase Auth -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDMx67HEtpWr7fPDsnBIBGznXTP9MIU9QU",
    authDomain: "mushroom-referral.firebaseapp.com",
    projectId: "mushroom-referral",
    storageBucket: "mushroom-referral.appspot.com",
    messagingSenderId: "1038687686201",
    appId: "1:1038687686201:web:c130be2734a3d42122c7e8",
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const pendingList = document.getElementById("pending-user-list");
  const approvedList = document.getElementById("approved-user-list");

  async function fetchUsers() {
    pendingList.innerHTML = "<tr><td colspan='3'>Loading...</td></tr>";
    approvedList.innerHTML = "<tr><td colspan='3'>Loading...</td></tr>";

    try {
      const pendingSnapshot = await db.collection('users')
        .where('approved', '==', false)
        .get();

      const approvedSnapshot = await db.collection('users')
        .where('approved', '==', true)
        .get();

      // Render pending users
      if (pendingSnapshot.empty) {
        pendingList.innerHTML = "<tr><td colspan='3'>No pending users.</td></tr>";
      } else {
        pendingList.innerHTML = "";
        pendingSnapshot.forEach(doc => {
          const user = doc.data();
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${user.name || '(No name)'}</td>
            <td>${user.email}</td>
            <td>
              <button class="approve-btn" onclick="approveUser('${doc.id}')">Approve</button>
              <button class="deny-btn" onclick="denyUser('${doc.id}')">Deny</button>
            </td>
          `;
          pendingList.appendChild(row);
        });
      }

      // Render approved users
      if (approvedSnapshot.empty) {
        approvedList.innerHTML = "<tr><td colspan='3'>No approved users.</td></tr>";
      } else {
        approvedList.innerHTML = "";
        approvedSnapshot.forEach(doc => {
          const user = doc.data();
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${user.name || '(No name)'}</td>
            <td>${user.email}</td>
            <td>
              <button class="deny-btn" onclick="denyUser('${doc.id}')">Remove</button>
            </td>
          `;
          approvedList.appendChild(row);
        });
      }
    } catch (error) {
      console.error("Error fetching users:", error);
      pendingList.innerHTML = "<tr><td colspan='3'>Failed to load users.</td></tr>";
      approvedList.innerHTML = "<tr><td colspan='3'>Failed to load users.</td></tr>";
    }
  }

  async function approveUser(userId) {
    if (!confirm("Are you sure you want to approve this user?")) return;

    try {
      await db.collection('users').doc(userId).update({ approved: true });
      alert("User approved!");
      fetchUsers();
    } catch (error) {
      console.error("Error approving user:", error);
      alert("Failed to approve user.");
    }
  }

  async function denyUser(userId) {
    if (!confirm("Are you sure you want to deny/remove this user? This action cannot be undone.")) return;

    try {
      await db.collection('users').doc(userId).delete();
      alert("User removed.");
      fetchUsers();
    } catch (error) {
      console.error("Error removing user:", error);
      alert("Failed to remove user.");
    }
  }

  // Auth state listener and admin check
  firebase.auth().onAuthStateChanged(async user => {
    if (!user) {
      // Not logged in
      window.location.href = "Referral Login.html";  // Redirect to login
      return;
    }

    const userDoc = await db.collection("users").doc(user.uid).get();
    if (!userDoc.exists || !userDoc.data().isAdmin) {
      alert("Access denied. You are not an admin.");
      await firebase.auth().signOut();
      window.location.href = "login.html";  // Redirect non-admin users
      return;
    }

    // User is admin, load users
    fetchUsers();
  });
</script>

</body>
</html>
