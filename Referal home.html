<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Referral Dashboard</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@500;600&display=swap');

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #6a11cb, #2575fc);
      min-height: 100vh;
      padding-bottom: 40px;
      color: #2c3e50;
    }

    header {
      background: linear-gradient(135deg, #5c6bc0, #3949ab);
      color: white;
      padding: 20px 40px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.25);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    header h1 {
      font-size: 28px;
      font-weight: 700;
      letter-spacing: 1.2px;
      text-shadow: 0 0 8px rgba(255, 255, 255, 0.7);
    }

    nav a {
      margin-left: 25px;
      color: white;
      text-decoration: none;
      font-weight: 600;
      font-size: 16px;
      transition: color 0.3s ease, text-shadow 0.3s ease;
      padding: 6px 12px;
      border-radius: 6px;
      user-select: none;
    }

    nav a:hover {
      color: #ffeb3b;
      text-shadow: 0 0 6px #ffeb3b;
      background: rgba(255, 255, 255, 0.15);
    }

    #logout-btn {
      background-color: #e53935;
      padding: 8px 14px;
      font-weight: 700;
      box-shadow: 0 0 8px rgba(229, 57, 53, 0.8);
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
    }

    #logout-btn:hover {
      background-color: #b71c1c;
      box-shadow: 0 0 14px rgba(183, 28, 28, 0.9);
    }

    main {
      max-width: 900px;
      margin: 30px auto;
      padding: 0 20px;
    }

    .card {
      background: white;
      padding: 30px 25px;
      border-radius: 18px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.12);
      margin-top: 30px;
      animation: fadeIn 0.5s ease-in-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }

    h2 {
      color: #3949ab;
      margin-bottom: 18px;
      font-weight: 700;
    }

    label, p {
      font-size: 17px;
      margin: 14px 0 8px 0;
      font-weight: 600;
    }

    .referral-row {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(200px,1fr));
      gap: 14px;
      margin-bottom: 20px;
    }

    input[type="text"], select {
      padding: 12px 14px;
      font-size: 16px;
      border: 1.8px solid #ccc;
      border-radius: 10px;
      width: 100%;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
      outline: none;
      font-weight: 500;
    }

    input[type="text"]:focus, select:focus {
      border-color: #6c5ce7;
      box-shadow: 0 0 10px #6c5ce7aa;
      background-color: #fafaff;
    }

    input[readonly] {
      background-color: #f0f0f0;
      font-style: italic;
      color: #777;
    }

    .total {
      font-weight: 700;
      font-size: 22px;
      margin-top: 28px;
      color: #2c3e50;
      text-align: right;
    }

    button {
      margin-top: 22px;
      padding: 14px 24px;
      font-size: 17px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.3s ease, box-shadow 0.3s ease;
      user-select: none;
      box-shadow: 0 3px 12px rgba(0,0,0,0.12);
    }

    #submit-order-btn {
      background-color: #6c5ce7;
      color: white;
      box-shadow: 0 0 14px #6c5ce7aa;
    }

    #submit-order-btn:hover {
      background-color: #4834d4;
      box-shadow: 0 0 20px #4834d4cc;
    }

    #view-order-history-btn {
      background-color: #5bc0de;
      color: white;
      margin-left: 12px;
      box-shadow: 0 0 12px #5bc0deaa;
    }

    #view-order-history-btn:hover {
      background-color: #31b0d5;
      box-shadow: 0 0 18px #31b0d5cc;
    }

    /* Modal Styles */
    #orderHistoryModal {
      display: none;
      position: fixed;
      z-index: 110;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(3px);
      animation: fadeIn 0.4s ease forwards;
    }

    #orderHistoryContent {
      background-color: white;
      margin: 6% auto;
      padding: 24px 30px;
      border-radius: 18px;
      width: 90%;
      max-width: 720px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      font-weight: 500;
    }

    #closeModalBtn {
      float: right;
      background-color: #e53935;
      color: white;
      border: none;
      padding: 6px 14px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
      box-shadow: 0 0 10px #e5393599;
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
      user-select: none;
    }

    #closeModalBtn:hover {
      background-color: #b71c1c;
      box-shadow: 0 0 14px #b71c1cbb;
    }
  </style>
</head>
<body>

<header>
  <h1>Referral Dashboard</h1>
  <nav>
    <a href="#">Home</a>
    <a href="#">My Orders</a>
    <a href="#">Account</a>
    <a href="#" id="logout-btn">Logout</a>
  </nav>
</header>

<main>
  <div id="user-info" class="card">
    <p>Loading user info...</p>
  </div>

  <div id="referral-section" class="card" style="display:none;">
    <h2>Referral Configuration</h2>
    <label for="referral-count">Select Number of Referrals:</label>
    <select id="referral-count" onchange="generateReferralFields()">
      <option value="5">5 Referrals</option>
      <option value="10">10 Referrals</option>
    </select>

    <div id="referral-fields"></div>

    <p class="total">Total Price: <span id="total-price">â‚±750</span></p>
    <button id="submit-order-btn">Submit Order</button>
    <button id="view-order-history-btn">View Order History</button>
  </div>
</main>

<!-- Modal -->
<div id="orderHistoryModal">
  <div id="orderHistoryContent">
    <button id="closeModalBtn">Close</button>
    <h2>Order History Summary</h2>
    <div id="orderHistoryDetails">
      <!-- Filled dynamically -->
    </div>
  </div>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDMx67HEtpWr7fPDsnBIBGznXTP9MIU9QU",
    authDomain: "mushroom-referral.firebaseapp.com",
    projectId: "mushroom-referral",
    storageBucket: "mushroom-referral.appspot.com",
    messagingSenderId: "1038687686201",
    appId: "1:1038687686201:web:c130be2734a3d42122c7e8",
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const userInfoDiv = document.getElementById("user-info");
  const logoutBtn = document.getElementById("logout-btn");
  const referralSection = document.getElementById("referral-section");

  const orderHistoryModal = document.getElementById("orderHistoryModal");
  const orderHistoryDetails = document.getElementById("orderHistoryDetails");
  const closeModalBtn = document.getElementById("closeModalBtn");
  const viewOrderHistoryBtn = document.getElementById("view-order-history-btn");

  let currentReferralCount = 0;
  let currentReferralCode = null;
  let currentUserName = "Unknown User"; // Store the username globally

  auth.onAuthStateChanged(async (user) => {
  if (user) {
    logoutBtn.style.display = "inline-block";
    referralSection.style.display = "block";

    try {
      const userRef = db.collection("users").doc(user.uid);
      const userDoc = await userRef.get();
      const userData = userDoc.exists ? userDoc.data() : {};



      // Dynamically calculate referral count from current orders
auth.onAuthStateChanged(async (user) => {
  if (user) {
    logoutBtn.style.display = "inline-block";
    referralSection.style.display = "block";

    try {
      const userRef = db.collection("users").doc(user.uid);
      const userDoc = await userRef.get();
      const userData = userDoc.exists ? userDoc.data() : {};

      currentReferralCode = userData.referralCode || null;
      currentUserName = userData.name || user.displayName || "Unknown User";

      // ðŸ”½ Add this block for dynamic referral count
      let liveReferralCount = 0;
      try {
        const currentOrdersSnapshot = await db.collection("orders")
          .where("userId", "==", user.uid)
          .get();

        currentOrdersSnapshot.forEach(orderDoc => {
          const orderData = orderDoc.data();
          liveReferralCount += orderData.quantity || 0;
        });

        currentReferralCount = liveReferralCount;
      } catch (error) {
        console.error("Error calculating referral count:", error);
        currentReferralCount = userData.referralCount || 0; // fallback
      }

      if (!currentReferralCode) {
        currentReferralCode = await generateUniqueReferralCode();
        await userRef.update({ referralCode: currentReferralCode });
      }

      // Now safe to render UI
      userInfoDiv.innerHTML = `
        <p><strong>Name:</strong> ${currentUserName}</p>
        <p><strong>Email:</strong> ${user.email}</p>
        <p><strong>Referral Code:</strong> ${currentReferralCode}</p>
        <p><strong>Referral Count:</strong> <span id="referral-count-display">${currentReferralCount}</span></p>
      `;
    } catch (error) {
      userInfoDiv.innerHTML = "<p>Failed to load user data.</p>";
      console.error("Error loading user data:", error);
    }
  }
});



      currentReferralCode = userData.referralCode || null;

      currentUserName = userData.name || user.displayName || "Unknown User";

      if (!currentReferralCode) {
        currentReferralCode = await generateUniqueReferralCode();
        await userRef.update({ referralCode: currentReferralCode });
      }

      // === COMMISSION CALCULATION LOGIC ===
      let totalCommission = 0;
      const userOrdersSnapshot = await db.collection("orders")
        .where("userId", "==", user.uid)
        .get();

      // Calculate commission for the user's orders
      for (const orderDoc of userOrdersSnapshot.docs) {
        const orderData = orderDoc.data();

      const adminOrdersSnapshot = await db.collection("orders")
  .doc(orderDoc.id)
  .collection("adminOrders")
  .orderBy("updatedAt", "desc")
  .limit(1)
  .get();

let orderQuantityPaid = 0;
let orderSummaryPaid = 0;

if (!adminOrdersSnapshot.empty) {
  const latestAdminData = adminOrdersSnapshot.docs[0].data();
  orderQuantityPaid = latestAdminData.quantityPaid || 0;
  orderSummaryPaid = latestAdminData.summaryPaid || 0;
}

        // Calculate commission for this order
        if (orderData.quantity === orderQuantityPaid) {
          if (orderQuantityPaid === 10) {
            totalCommission += orderSummaryPaid * 0.13;
          } else if (orderQuantityPaid === 5) {
            totalCommission += orderSummaryPaid * 0.10;
          }
        }
      }

      // Update user info with the computed commission
      userInfoDiv.innerHTML = `
        <p><strong>Name:</strong> ${currentUserName}</p>
        <p><strong>Email:</strong> ${user.email}</p>
        <p><strong>Referral Code:</strong> ${currentReferralCode}</p>
        <p><strong>Referral Count:</strong> <span id="referral-count-display">${currentReferralCount}</span></p>
        <p><strong>Earned Commission:</strong> â‚±${totalCommission.toFixed(2)}</p>
      `;
    } catch (error) {
      userInfoDiv.innerHTML = "<p>Failed to load user data.</p>";
      console.error("Error fetching user data:", error);
    }
  } else {
    userInfoDiv.innerHTML = "<p>You are not logged in. Please <a href='Referral Login.html'>login or sign up</a>.</p>";
    logoutBtn.style.display = "none";
    referralSection.style.display = "none";
  }
});


  logoutBtn.addEventListener("click", () => {
    auth.signOut().then(() => location.reload());
  });

  function generateReferralFields() {
    const count = parseInt(document.getElementById("referral-count").value);
    const container = document.getElementById("referral-fields");
    const totalDisplay = document.getElementById("total-price");
    const pricePerReferral = 150;

    container.innerHTML = "";

    for (let i = 1; i <= count; i++) {
      const row = document.createElement("div");
      row.className = "referral-row";
      row.innerHTML = `
        <input type="text" placeholder="Referral Name ${i}" name="referral${i}" />
        <input type="text" value="Mushroom Chicharon" readonly />
        <input type="text" value="â‚±150" readonly />
      `;
      container.appendChild(row);
    }

    totalDisplay.textContent = `â‚±${count * pricePerReferral}`;
  }

  // Generate fields on load
  window.onload = generateReferralFields;

  // Generate unique referral code atomically
  async function generateUniqueReferralCode() {
    const counterRef = db.collection("counters").doc("referralCode");
    return await db.runTransaction(async (transaction) => {
      const counterDoc = await transaction.get(counterRef);
      let newCode = 1;
      if (!counterDoc.exists) {
        transaction.set(counterRef, { lastCode: newCode });
      } else {
        newCode = counterDoc.data().lastCode + 1;
        transaction.update(counterRef, { lastCode: newCode });
      }
      return newCode.toString();
    });
  }

  // Generate unique order number formatted as 5-digit string
  async function generateUniqueOrderNumber() {
    const counterRef = db.collection("counters").doc("orderNumber");
    return await db.runTransaction(async (transaction) => {
      const counterDoc = await transaction.get(counterRef);
      let newNumber = 1;
      if (!counterDoc.exists) {
        transaction.set(counterRef, { lastNumber: newNumber });
      } else {
        newNumber = counterDoc.data().lastNumber + 1;
        transaction.update(counterRef, { lastNumber: newNumber });
      }
      return newNumber.toString().padStart(5, '0');
    });
  }

  document.getElementById("submit-order-btn").addEventListener("click", async () => {
    const user = auth.currentUser;
    if (!user) return alert("You must be logged in to submit an order.");

    const referralInputs = document.querySelectorAll("#referral-fields input[type='text']:not([readonly])");
    const referrals = Array.from(referralInputs)
      .map(input => input.value.trim())
      .filter(name => name.length > 0);

    if (referrals.length === 0) {
      alert("Please enter at least one referral name.");
      return;
    }

    const pricePerItem = 150;
    const quantity = referrals.length;
    const totalPrice = quantity * pricePerItem;

    try {
      const orderNumber = await generateUniqueOrderNumber();

      const userRef = db.collection("users").doc(user.uid);
      const userDoc = await userRef.get();
      const userData = userDoc.exists ? userDoc.data() : {};

      let referralCode = userData.referralCode;
      if (!referralCode) {
        referralCode = await generateUniqueReferralCode();
        await userRef.update({ referralCode });
      }

      // Use stored username here
      const username = currentUserName;

      const order = {
        userId: user.uid,     // <-- Added userId for permissions and querying
        username,             // existing username field
        referralNames: referrals,
        product: "Mushroom Chicharon",
        pricePerItem,
        quantity,
        totalPrice,
        referralCode,
        orderNumber,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      await db.collection("orders").add(order);

      const updatedCount = (userData.referralCount || 0) + quantity;
      await userRef.update({ referralCount: updatedCount });

      currentReferralCount = updatedCount;
      document.getElementById("referral-count-display").textContent = updatedCount;

      referralInputs.forEach(input => input.value = "");

      alert(`Order submitted successfully! Your referral code is ${referralCode} and your order number is ${orderNumber}.`);

    } catch (error) {
      console.error("Error submitting order:", error);
      alert(`Failed to submit order: ${error.message || error}`);
    }
  });

  viewOrderHistoryBtn.addEventListener("click", async () => {
  const user = auth.currentUser;
  if (!user) return alert("You must be logged in to view order history.");

  orderHistoryDetails.innerHTML = "<p>Loading order history...</p>";
  orderHistoryModal.style.display = "block";

  try {
    const ordersQuery = await db.collection("orders")
      .where("userId", "==", user.uid)
      .orderBy("createdAt", "desc")
      .get();

    if (ordersQuery.empty) {
      orderHistoryDetails.innerHTML = "<p>No orders found.</p>";
      return;
    }

    let html = "";
    let totalCommission = 0;

    for (const orderDoc of ordersQuery.docs) {
      const orderData = orderDoc.data();

      const adminOrdersSnapshot = await db.collection("orders")
        .doc(orderDoc.id)
        .collection("adminOrders")
        .get();

      let orderQuantityPaid = 0;
      let orderSummaryPaid = 0;

      adminOrdersSnapshot.forEach(adminOrderDoc => {
        const adminData = adminOrderDoc.data();
        orderQuantityPaid += adminData.quantityPaid || 0;
        orderSummaryPaid += adminData.summaryPaid || 0;
      });

      // Clamp to not exceed total quantity
      const cappedQuantityPaid = Math.min(orderQuantityPaid, orderData.quantity);

      // Compute commission per completed order
      let commissionForThisOrder = 0;
      if (orderData.quantity === cappedQuantityPaid) {
        if (cappedQuantityPaid === 10) {
          commissionForThisOrder = orderSummaryPaid * 0.13;
        } else if (cappedQuantityPaid === 5) {
          commissionForThisOrder = orderSummaryPaid * 0.10;
        }
        totalCommission += commissionForThisOrder;
      }

      const statusTag = (orderData.quantity === cappedQuantityPaid)
        ? '<span style="color: green; font-weight: bold;">Complete</span>'
        : '<span style="color: orange; font-weight: bold;">Pending</span>';

      html += 
        `<div style="border-bottom:1px solid #ddd; padding:10px 0;">
          <p><strong>Order Number:</strong> ${orderData.orderNumber || "N/A"}</p>
          <p><strong>Order Date:</strong> ${orderData.createdAt?.toDate().toLocaleString() || "N/A"}</p>
          <p><strong>Product:</strong> ${orderData.product}</p>
          <p><strong>Total Quantity Ordered:</strong> ${orderData.quantity}</p>
          <p><strong>Quantity Paid:</strong> ${cappedQuantityPaid}</p>
          <p><strong>Summary Paid:</strong> â‚±${orderSummaryPaid.toFixed(2)}</p>
          <p><strong>Status:</strong> ${statusTag}</p>`;

      if (commissionForThisOrder > 0) {
        html += `<p><strong>Commission from this order:</strong> â‚±${commissionForThisOrder.toFixed(2)}</p>`;
      }

      html += `</div>`;
    }

    if (totalCommission > 0) {
      html += `<p style="color: green; font-weight: bold;">Total Earned Commission: â‚±${totalCommission.toFixed(2)}</p>`;
    } else {
      html += `<p style="color: gray;">No commission earned yet. Earn 10% for 5 paid referrals or 13% for 10.</p>`;
    }

    orderHistoryDetails.innerHTML = html;

  } catch (error) {
    orderHistoryDetails.innerHTML = `<p>Error loading order history: ${error.message}</p>`;
    console.error("Error fetching order history:", error);
  }
});


  closeModalBtn.addEventListener("click", () => {
    orderHistoryModal.style.display = "none";
  });

  // Close modal if user clicks outside the modal content
  window.onclick = function(event) {
    if (event.target === orderHistoryModal) {
      orderHistoryModal.style.display = "none";
    }
  }
</script>


</body>
</html>
