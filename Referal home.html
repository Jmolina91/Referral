<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Referral Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 40px;
      background-color: #f9f9f9;
      max-width: 800px;
      margin: auto;
    }
    h1 {
      color: #333;
    }
    #user-info, #referral-section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
      margin-top: 20px;
    }
    p, label {
      font-size: 18px;
      margin: 10px 0;
    }
    .referral-row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
    }
    input[type="text"] {
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-size: 16px;
      width: 100%;
    }
    input[readonly] {
      background-color: #eee;
      color: #333;
    }
    select {
      padding: 8px;
      font-size: 16px;
      margin-bottom: 15px;
    }
    .total {
      font-weight: bold;
      font-size: 20px;
      color: #2c3e50;
      margin-top: 15px;
    }
    button {
      margin-top: 20px;
      background-color: #d9534f;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background-color: #c9302c;
    }
    /* Modal styles for order history */
    #orderHistoryModal {
      display: none;
      position: fixed;
      z-index: 100;
      left: 0; top: 0;
      width: 100%; height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.5);
    }
    #orderHistoryContent {
      background-color: #fff;
      margin: 10% auto;
      padding: 20px;
      border-radius: 8px;
      max-width: 600px;
      max-height: 70vh;
      overflow-y: auto;
    }
    #closeModalBtn {
      float: right;
      background-color: #d9534f;
      border: none;
      padding: 5px 10px;
      color: white;
      font-weight: bold;
      cursor: pointer;
      border-radius: 4px;
    }
    #closeModalBtn:hover {
      background-color: #c9302c;
    }
  </style>
</head>
<body>

<h1>Referral Dashboard</h1>

<div id="user-info">
  <p>Loading user info...</p>
</div>

<div id="referral-section" style="display:none;">
  <h2>Referral Configuration</h2>
  <label for="referral-count">Select Number of Referrals:</label>
  <select id="referral-count" onchange="generateReferralFields()">
    <option value="5">5 Referrals</option>
    <option value="10">10 Referrals</option>
  </select>

  <div id="referral-fields"></div>

  <p class="total">Total Price: <span id="total-price">₱750</span></p>
  <button id="submit-order-btn">Submit Order</button>

  <!-- New button to view order history -->
  <button id="view-order-history-btn" style="background-color:#5bc0de; margin-left: 10px;">View Order History</button>
</div>

<button id="logout-btn" style="display:none;">Logout</button>

<!-- Modal for order history -->
<div id="orderHistoryModal">
  <div id="orderHistoryContent">
    <button id="closeModalBtn">Close</button>
    <h2>Order History Summary</h2>
    <div id="orderHistoryDetails">
      <!-- Filled dynamically -->
    </div>
  </div>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDMx67HEtpWr7fPDsnBIBGznXTP9MIU9QU",
    authDomain: "mushroom-referral.firebaseapp.com",
    projectId: "mushroom-referral",
    storageBucket: "mushroom-referral.appspot.com",
    messagingSenderId: "1038687686201",
    appId: "1:1038687686201:web:c130be2734a3d42122c7e8",
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const userInfoDiv = document.getElementById("user-info");
  const logoutBtn = document.getElementById("logout-btn");
  const referralSection = document.getElementById("referral-section");

  const orderHistoryModal = document.getElementById("orderHistoryModal");
  const orderHistoryDetails = document.getElementById("orderHistoryDetails");
  const closeModalBtn = document.getElementById("closeModalBtn");
  const viewOrderHistoryBtn = document.getElementById("view-order-history-btn");

  let currentReferralCount = 0;
  let currentReferralCode = null;
  let currentUserName = "Unknown User"; // Store the username globally

  auth.onAuthStateChanged(async (user) => {
    if (user) {
      logoutBtn.style.display = "inline-block";
      referralSection.style.display = "block";

      try {
        const userRef = db.collection("users").doc(user.uid);
        const userDoc = await userRef.get();
        const userData = userDoc.exists ? userDoc.data() : {};

        currentReferralCount = userData.referralCount || 0;
        currentReferralCode = userData.referralCode || null;

        // Store username from Firestore or fallback to displayName
        currentUserName = userData.name || user.displayName || "Unknown User";

        if (!currentReferralCode) {
          currentReferralCode = await generateUniqueReferralCode();
          await userRef.update({ referralCode: currentReferralCode });
        }

        userInfoDiv.innerHTML = `
          <p><strong>Name:</strong> ${currentUserName}</p>
          <p><strong>Email:</strong> ${user.email}</p>
          <p><strong>Referral Code:</strong> ${currentReferralCode}</p>
          <p><strong>Referral Count:</strong> <span id="referral-count-display">${currentReferralCount}</span></p>
        `;

      } catch (error) {
        userInfoDiv.innerHTML = "<p>Failed to load user data.</p>";
        console.error("Error fetching user data:", error);
      }
    } else {
      userInfoDiv.innerHTML = "<p>You are not logged in. Please <a href='signup.html'>login or sign up</a>.</p>";
      logoutBtn.style.display = "none";
      referralSection.style.display = "none";
    }
  });

  logoutBtn.addEventListener("click", () => {
    auth.signOut().then(() => location.reload());
  });

  function generateReferralFields() {
    const count = parseInt(document.getElementById("referral-count").value);
    const container = document.getElementById("referral-fields");
    const totalDisplay = document.getElementById("total-price");
    const pricePerReferral = 150;

    container.innerHTML = "";

    for (let i = 1; i <= count; i++) {
      const row = document.createElement("div");
      row.className = "referral-row";
      row.innerHTML = `
        <input type="text" placeholder="Referral Name ${i}" name="referral${i}" />
        <input type="text" value="Mushroom Chicharon" readonly />
        <input type="text" value="₱150" readonly />
      `;
      container.appendChild(row);
    }

    totalDisplay.textContent = `₱${count * pricePerReferral}`;
  }

  // Generate fields on load
  window.onload = generateReferralFields;

  // Generate unique referral code atomically
  async function generateUniqueReferralCode() {
    const counterRef = db.collection("counters").doc("referralCode");
    return await db.runTransaction(async (transaction) => {
      const counterDoc = await transaction.get(counterRef);
      let newCode = 1;
      if (!counterDoc.exists) {
        transaction.set(counterRef, { lastCode: newCode });
      } else {
        newCode = counterDoc.data().lastCode + 1;
        transaction.update(counterRef, { lastCode: newCode });
      }
      return newCode.toString();
    });
  }

  // Generate unique order number formatted as 5-digit string
  async function generateUniqueOrderNumber() {
    const counterRef = db.collection("counters").doc("orderNumber");
    return await db.runTransaction(async (transaction) => {
      const counterDoc = await transaction.get(counterRef);
      let newNumber = 1;
      if (!counterDoc.exists) {
        transaction.set(counterRef, { lastNumber: newNumber });
      } else {
        newNumber = counterDoc.data().lastNumber + 1;
        transaction.update(counterRef, { lastNumber: newNumber });
      }
      return newNumber.toString().padStart(5, '0');
    });
  }

  document.getElementById("submit-order-btn").addEventListener("click", async () => {
    const user = auth.currentUser;
    if (!user) return alert("You must be logged in to submit an order.");

    const referralInputs = document.querySelectorAll("#referral-fields input[type='text']:not([readonly])");
    const referrals = Array.from(referralInputs)
      .map(input => input.value.trim())
      .filter(name => name.length > 0);

    if (referrals.length === 0) {
      alert("Please enter at least one referral name.");
      return;
    }

    const pricePerItem = 150;
    const quantity = referrals.length;
    const totalPrice = quantity * pricePerItem;

    try {
      const orderNumber = await generateUniqueOrderNumber();

      const userRef = db.collection("users").doc(user.uid);
      const userDoc = await userRef.get();
      const userData = userDoc.exists ? userDoc.data() : {};

      let referralCode = userData.referralCode;
      if (!referralCode) {
        referralCode = await generateUniqueReferralCode();
        await userRef.update({ referralCode });
      }

      // Use stored username here
      const username = currentUserName;

      const order = {
        userId: user.uid,     // <-- Added userId for permissions and querying
        username,             // existing username field
        referralNames: referrals,
        product: "Mushroom Chicharon",
        pricePerItem,
        quantity,
        totalPrice,
        referralCode,
        orderNumber,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      await db.collection("orders").add(order);

      const updatedCount = (userData.referralCount || 0) + quantity;
      await userRef.update({ referralCount: updatedCount });

      currentReferralCount = updatedCount;
      document.getElementById("referral-count-display").textContent = updatedCount;

      referralInputs.forEach(input => input.value = "");

      alert(`Order submitted successfully! Your referral code is ${referralCode} and your order number is ${orderNumber}.`);

    } catch (error) {
      console.error("Error submitting order:", error);
      alert(`Failed to submit order: ${error.message || error}`);
    }
  });

  // ===== View Order History Button Handler =====
  viewOrderHistoryBtn.addEventListener("click", async () => {
    const user = auth.currentUser;
    if (!user) return alert("You must be logged in to view order history.");

    orderHistoryDetails.innerHTML = "<p>Loading order history...</p>";
    orderHistoryModal.style.display = "block";

    try {
      // Query orders by userId instead of username for proper permissions
      const ordersQuery = await db.collection("orders")
        .where("userId", "==", user.uid)     // <-- Changed here from username to userId
        .orderBy("createdAt", "desc")
        .get();

      if (ordersQuery.empty) {
        orderHistoryDetails.innerHTML = "<p>No orders found.</p>";
        return;
      }

      let overallQuantityPaid = 0;
      let overallSummaryPaid = 0;

      let html = "";

      for (const orderDoc of ordersQuery.docs) {
        const orderData = orderDoc.data();

        // Fetch adminOrders subcollection for this order
        const adminOrdersSnapshot = await db.collection("orders")
          .doc(orderDoc.id)
          .collection("adminOrders")
          .get();

        let orderQuantityPaid = 0;
        let orderSummaryPaid = 0;

        adminOrdersSnapshot.forEach(adminOrderDoc => {
          const adminData = adminOrderDoc.data();
          orderQuantityPaid += adminData.quantityPaid || 0;
          orderSummaryPaid += adminData.summaryPaid || 0;
        });

        overallQuantityPaid += orderQuantityPaid;
        overallSummaryPaid += orderSummaryPaid;

        html += `
          <div style="border-bottom:1px solid #ddd; padding:10px 0;">
            <p><strong>Order Number:</strong> ${orderData.orderNumber || "N/A"}</p>
            <p><strong>Order Date:</strong> ${orderData.createdAt?.toDate().toLocaleString() || "N/A"}</p>
            <p><strong>Product:</strong> ${orderData.product}</p>
            <p><strong>Total Quantity Ordered:</strong> ${orderData.quantity}</p>
            <p><strong>Quantity Paid:</strong> ${orderQuantityPaid}</p>
            <p><strong>Summary Paid:</strong> ₱${orderSummaryPaid.toFixed(2)}</p>
          </div>
        `;
      }

      html += `
        <hr />
        <p><strong>Overall Quantity Paid:</strong> ${overallQuantityPaid}</p>
        <p><strong>Overall Summary Paid:</strong> ₱${overallSummaryPaid.toFixed(2)}</p>
      `;

      orderHistoryDetails.innerHTML = html;

    } catch (error) {
      orderHistoryDetails.innerHTML = `<p>Error loading order history: ${error.message}</p>`;
      console.error("Error fetching order history:", error);
    }
  });

  closeModalBtn.addEventListener("click", () => {
    orderHistoryModal.style.display = "none";
  });

  // Close modal if user clicks outside the modal content
  window.onclick = function(event) {
    if (event.target === orderHistoryModal) {
      orderHistoryModal.style.display = "none";
    }
  }
</script>


</body>
</html>
